import { test, expect } from '@playwright/test'

/**
 * E2E æµ‹è¯• - Blog Circle ç«¯åˆ°ç«¯æµ‹è¯•
 * 
 * æµ‹è¯•åœºæ™¯ï¼š
 * 1. ç”¨æˆ·ç™»å½•æµç¨‹
 * 2. å‘å¸ƒåŠ¨æ€ï¼ˆæ–‡å­—+å›¾ç‰‡ï¼‰
 * 3. ç‚¹èµä¸è¯„è®ºäº¤äº’
 * 4. æ»šåŠ¨åŠ è½½
 */
test.describe('Blog Circle E2E Tests', () => {
  test.beforeEach(async ({ page }) => {
    // è®¿é—®é¦–é¡µ
    await page.goto('http://localhost:5173')
  })

  test('åœºæ™¯1: ç”¨æˆ·ç™»å½•æµç¨‹', async ({ page }) => {
    // Given: ç”¨æˆ·åœ¨é¦–é¡µ
    await expect(page).toHaveURL(/.*\/home/)

    // When: ç‚¹å‡»ç™»å½•æŒ‰é’®
    await page.click('text=ç™»å½•')

    // Then: åº”è¯¥è·³è½¬åˆ°ç™»å½•é¡µ
    await expect(page).toHaveURL(/.*\/login/)

    // When: è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
    await page.fill('input[placeholder="ç”¨æˆ·å"]', 'admin')
    await page.fill('input[placeholder="å¯†ç "]', 'admin123')

    // When: ç‚¹å‡»ç™»å½•æŒ‰é’®
    await page.click('button:has-text("ç™»å½•")')

    // Then: åº”è¯¥ç™»å½•æˆåŠŸå¹¶è·³è½¬åˆ°é¦–é¡µ
    await page.waitForURL(/.*\/home/, { timeout: 5000 })
    await expect(page.locator('text=å‘è¡¨åŠ¨æ€')).toBeVisible()
  })

  test('åœºæ™¯2: å‘å¸ƒåŠ¨æ€ï¼ˆæ–‡å­—ï¼‰', async ({ page }) => {
    // Given: ç”¨æˆ·å·²ç™»å½•
    await page.goto('http://localhost:5173/login')
    await page.fill('input[placeholder="ç”¨æˆ·å"]', 'admin')
    await page.fill('input[placeholder="å¯†ç "]', 'admin123')
    await page.click('button:has-text("ç™»å½•")')
    await page.waitForURL(/.*\/home/)

    // When: ç‚¹å‡»å‘è¡¨åŠ¨æ€æŒ‰é’®
    await page.click('text=å‘è¡¨åŠ¨æ€')

    // Then: åº”è¯¥è·³è½¬åˆ°å‘è¡¨é¡µé¢
    await expect(page).toHaveURL(/.*\/publish/)

    // When: è¾“å…¥åŠ¨æ€å†…å®¹
    await page.fill('textarea[placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."]', 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•åŠ¨æ€')

    // When: ç‚¹å‡»å‘å¸ƒæŒ‰é’®
    await page.click('button:has-text("å‘å¸ƒ")')

    // Then: åº”è¯¥å‘å¸ƒæˆåŠŸå¹¶è·³è½¬åˆ°é¦–é¡µ
    await page.waitForURL(/.*\/home/, { timeout: 5000 })
    await expect(page.locator('text=è¿™æ˜¯ä¸€æ¡æµ‹è¯•åŠ¨æ€')).toBeVisible({ timeout: 5000 })
  })

  test('åœºæ™¯3: ç‚¹èµä¸è¯„è®ºäº¤äº’', async ({ page }) => {
    // Given: ç”¨æˆ·å·²ç™»å½•å¹¶åœ¨é¦–é¡µ
    await page.goto('http://localhost:5173/login')
    await page.fill('input[placeholder="ç”¨æˆ·å"]', 'admin')
    await page.fill('input[placeholder="å¯†ç "]', 'admin123')
    await page.click('button:has-text("ç™»å½•")')
    await page.waitForURL(/.*\/home/)

    // When: ç‚¹å‡»ç‚¹èµæŒ‰é’®
    const likeButton = page.locator('button.action-btn').first()
    await likeButton.click()

    // Then: ç‚¹èµæŒ‰é’®åº”è¯¥å˜ä¸ºå·²ç‚¹èµçŠ¶æ€
    await expect(likeButton.locator('text=â¤ï¸')).toBeVisible({ timeout: 2000 })

    // When: ç‚¹å‡»è¯„è®ºæŒ‰é’®
    const commentButtons = page.locator('button.action-btn')
    const commentButton = commentButtons.filter({ hasText: 'ğŸ’¬' }).first()
    await commentButton.click()

    // Then: åº”è¯¥æ˜¾ç¤ºè¯„è®ºè¾“å…¥æ¡†
    await expect(page.locator('input[placeholder="å†™è¯„è®º..."]')).toBeVisible()
  })

  test('åœºæ™¯4: æ»šåŠ¨åŠ è½½', async ({ page }) => {
    // Given: ç”¨æˆ·åœ¨é¦–é¡µ
    await page.goto('http://localhost:5173/home')

    // When: æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨
    await page.evaluate(() => {
      window.scrollTo(0, document.body.scrollHeight)
    })

    // Then: åº”è¯¥åŠ è½½æ›´å¤šå†…å®¹
    await page.waitForTimeout(1000)
    const moments = page.locator('.moment-item')
    const count = await moments.count()
    expect(count).toBeGreaterThan(0)
  })

  test('åœºæ™¯5: å¯¼èˆªæ åŠŸèƒ½', async ({ page }) => {
    // Given: ç”¨æˆ·åœ¨é¦–é¡µ
    await page.goto('http://localhost:5173/home')

    // When: ç‚¹å‡»Logo
    await page.click('text=Blog Circle')

    // Then: åº”è¯¥åœç•™åœ¨é¦–é¡µ
    await expect(page).toHaveURL(/.*\/home/)

    // When: ç‚¹å‡»ä¸ªäººä¸»é¡µï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
    try {
      await page.click('text=æµ‹è¯•ç”¨æˆ·', { timeout: 2000 })
      await expect(page).toHaveURL(/.*\/profile/)
    } catch (e) {
      // å¦‚æœæœªç™»å½•ï¼Œè·³è¿‡æ­¤æµ‹è¯•
      console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡ä¸ªäººä¸»é¡µæµ‹è¯•')
    }
  })
})

