# Blog Circle 系统实验报告 - 功能模块设计与实现

## 3.8 功能模块设计与实现

### 3.8.1 系统功能架构

本系统采用分层架构设计，包含用户认证、文章管理、社交互动、数据统计四大核心模块：

```
┌─────────────────────────────────────────────────────────────┐
│                      前端展示层                              │
│         用户界面 | 路由管理 | 状态管理 | API 调用            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      后端控制层                              │
│    AuthController | PostController | FriendshipController   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                              │
│      UserService | PostService | FriendshipService          │
│         SparkAnalyticsService | StatisticsService            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据访问层                              │
│    UserMapper | PostMapper | FriendshipMapper               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据持久层                              │
│         openGauss 9.2.4 一主二备集群                        │
└─────────────────────────────────────────────────────────────┘
```

### 3.8.2 用户认证模块

#### 设计目标

- 安全的用户注册与登录机制
- JWT Token 无状态身份认证
- 密码加密存储（BCrypt）
- 用户信息管理

#### 核心实现

**1. 用户注册**

```java
@PostMapping("/register")
public Result<?> register(@RequestBody @Valid RegisterRequest request) {
    // 1. 参数校验
    if (userService.existsByUsername(request.getUsername())) {
        return Result.error("用户名已存在");
    }

    // 2. 密码加密（BCrypt）
    User user = new User();
    user.setPassword(BCrypt.hashpw(request.getPassword(), BCrypt.gensalt()));

    // 3. 写入主库
    userService.createUser(user);

    return Result.success("注册成功");
}
```

**2. 用户登录**

```java
@PostMapping("/login")
public Result<LoginResponse> login(@RequestBody @Valid LoginRequest request) {
    // 1. 从备库查询用户（读操作）
    User user = userService.getUserByUsername(request.getUsername());

    // 2. 验证密码
    if (!BCrypt.checkpw(request.getPassword(), user.getPassword())) {
        return Result.error("用户名或密码错误");
    }

    // 3. 生成 JWT Token（有效期 24 小时）
    String token = jwtUtil.generateToken(user.getId(), user.getUsername());

    return Result.success(new LoginResponse(token, user));
}
```

#### 数据库表设计

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,        -- BCrypt 加密
    email VARCHAR(100) UNIQUE NOT NULL,
    nickname VARCHAR(50),
    avatar VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
```

### 3.8.3 文章管理模块

#### 设计目标

- 支持富文本内容和多图上传（最多 9 张）
- 文章 CRUD 操作
- 浏览量统计
- 好友时间线（仅显示好友动态）

#### 核心实现

**1. 发布文章**

```java
@PostMapping
public Result<Post> createPost(@RequestBody @Valid PostRequest request,
                               @RequestAttribute Long userId) {
    Post post = new Post();
    post.setContent(request.getContent());
    post.setAuthorId(userId);
    post.setImages(request.getImages());  // 最多 9 张

    postService.createPost(post);  // 写主库

    return Result.success(post);
}
```

**2. 获取好友时间线**

```java
@GetMapping("/timeline")
@ReadOnly  // 从备库读取
public Result<List<PostVO>> getTimeline(@RequestAttribute Long userId) {
    // 1. 查询好友列表
    List<Long> friendIds = friendshipService.getFriendIds(userId);
    friendIds.add(userId);

    // 2. 查询好友文章
    List<Post> posts = postService.getPostsByAuthorIds(friendIds);

    return Result.success(posts);
}
```

#### 数据库表设计

```sql
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    title VARCHAR(200),
    content TEXT NOT NULL,
    author_id INTEGER REFERENCES users(id),
    images TEXT[],                         -- PostgreSQL 数组
    view_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_posts_author_id ON posts(author_id);
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);
```

### 3.8.4 社交互动模块

#### 设计目标

- 好友搜索与添加
- 好友请求管理
- 文章点赞（防重复）
- 文章评论

#### 核心实现

**1. 好友请求**

```java
@PostMapping("/request/{receiverId}")
public Result<?> sendFriendRequest(@PathVariable Long receiverId,
                                   @RequestAttribute Long userId) {
    Friendship friendship = new Friendship();
    friendship.setRequesterId(userId);
    friendship.setReceiverId(receiverId);
    friendship.setStatus("PENDING");

    friendshipService.createRequest(friendship);

    return Result.success("好友请求已发送");
}
```

**2. 文章点赞**

```java
@PostMapping("/{postId}/like")
public Result<?> likePost(@PathVariable Long postId,
                         @RequestAttribute Long userId) {
    if (likeService.isLiked(userId, postId)) {
        return Result.error("已经点赞过了");
    }

    likeService.createLike(userId, postId);
    return Result.success("点赞成功");
}
```

#### 数据库表设计

```sql
-- 好友关系表
CREATE TABLE friendship (
    id SERIAL PRIMARY KEY,
    requester_id INTEGER REFERENCES users(id),
    receiver_id INTEGER REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(requester_id, receiver_id)
);

-- 点赞表
CREATE TABLE likes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    post_id INTEGER REFERENCES posts(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, post_id)  -- 防止重复点赞
);

-- 评论表
CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    post_id INTEGER REFERENCES posts(id),
    user_id INTEGER REFERENCES users(id),
    content TEXT NOT NULL,
    parent_id INTEGER REFERENCES comments(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.8.5 数据统计模块

#### 设计目标

- 用户发文数量统计
- 文章浏览量统计
- 支持 Spark 分析和 SQL 备用方案

#### 核心实现

```java
@PostMapping("/analyze")
public Result<?> runAnalytics() {
    try {
        sparkAnalyticsService.runSparkAnalytics();
        return Result.success("Spark 分析完成");
    } catch (Exception e) {
        sparkAnalyticsService.runSqlAnalytics();
        return Result.success("SQL 分析完成");
    }
}
```

#### 数据库表设计

```sql
CREATE TABLE statistics (
    id SERIAL PRIMARY KEY,
    stat_type VARCHAR(50) NOT NULL,
    stat_key VARCHAR(100) NOT NULL,
    stat_value BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(stat_type, stat_key)
);
```
