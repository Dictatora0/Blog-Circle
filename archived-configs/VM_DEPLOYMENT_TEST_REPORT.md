# è™šæ‹Ÿæœº Docker å®¹å™¨åŒ–éƒ¨ç½²æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: 2025-11-22 12:40  
**è™šæ‹Ÿæœº**: 10.211.55.11 (openEuler 22.03 LTS)  
**éƒ¨ç½²æ–¹å¼**: Docker Compose å®¹å™¨åŒ–éƒ¨ç½²

---

## âœ… éƒ¨ç½²å®Œæˆæƒ…å†µ

### 1. ç¯å¢ƒå‡†å¤‡

- âœ… æ¸…ç†è™šæ‹Ÿæœºæ—§ç¯å¢ƒï¼ˆå®¹å™¨ã€é•œåƒã€æ•°æ®ï¼‰
- âœ… åŒæ­¥é¡¹ç›®æ–‡ä»¶åˆ°è™šæ‹Ÿæœº
- âœ… é…ç½® Docker Compose 3.3ï¼ˆå…¼å®¹è™šæ‹Ÿæœºç‰ˆæœ¬ï¼‰

### 2. é•œåƒæ„å»º

ç”±äºè™šæ‹Ÿæœºç½‘ç»œé™åˆ¶ï¼Œé‡‡ç”¨æœ¬åœ°æ„å»º + ä¼ è¾“æ–¹æ¡ˆï¼š

- âœ… æœ¬åœ°æ„å»ºåç«¯é•œåƒï¼š`cloudcom-backend:vm`
- âœ… æœ¬åœ°æ„å»ºå‰ç«¯é•œåƒï¼š`cloudcom-frontend:vm`
- âœ… ä¼ è¾“ PostgreSQL 13 é•œåƒåˆ°è™šæ‹Ÿæœº
- âœ… æ‰€æœ‰é•œåƒæˆåŠŸåŠ è½½åˆ°è™šæ‹Ÿæœº

### 3. æœåŠ¡éƒ¨ç½²

æˆåŠŸéƒ¨ç½² 5 ä¸ªå®¹å™¨æœåŠ¡ï¼š

| æœåŠ¡å           | å®¹å™¨å              | é•œåƒ                 | ç«¯å£ | çŠ¶æ€            |
| ---------------- | ------------------- | -------------------- | ---- | --------------- |
| **æ•°æ®åº“ä¸»åº“**   | gaussdb-primary     | postgres:13-alpine   | 5432 | âœ… Up (healthy) |
| **æ•°æ®åº“å¤‡åº“ 1** | gaussdb-standby1    | postgres:13-alpine   | 5434 | âœ… Up (healthy) |
| **æ•°æ®åº“å¤‡åº“ 2** | gaussdb-standby2    | postgres:13-alpine   | 5436 | âœ… Up (healthy) |
| **åç«¯æœåŠ¡**     | blogcircle-backend  | cloudcom-backend:vm  | 8082 | âœ… Up           |
| **å‰ç«¯æœåŠ¡**     | blogcircle-frontend | cloudcom-frontend:vm | 8080 | âœ… Up (healthy) |

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•ç»“æœ

### 1. æ•°æ®åº“é›†ç¾¤æµ‹è¯•

#### ä¸»åº“æµ‹è¯•

```bash
$ docker exec gaussdb-primary pg_isready -U bloguser
/var/run/postgresql:5432 - accepting connections
âœ… çŠ¶æ€ï¼šæ­£å¸¸
```

#### å¤‡åº“æµ‹è¯•

```bash
$ docker exec gaussdb-standby1 pg_isready -U bloguser
/var/run/postgresql:5432 - accepting connections
âœ… å¤‡åº“1ï¼šæ­£å¸¸

$ docker exec gaussdb-standby2 pg_isready -U bloguser
/var/run/postgresql:5432 - accepting connections
âœ… å¤‡åº“2ï¼šæ­£å¸¸
```

#### æ•°æ®åº“è¿æ¥ä¿¡æ¯

- **ä¸»åº“**: 10.211.55.11:5432
- **å¤‡åº“ 1**: 10.211.55.11:5434
- **å¤‡åº“ 2**: 10.211.55.11:5436
- **æ•°æ®åº“**: blog_db
- **ç”¨æˆ·**: bloguser
- **å¯†ç **: Blog@2025

### 2. åç«¯æœåŠ¡æµ‹è¯•

#### å¥åº·æ£€æŸ¥

```bash
$ curl http://10.211.55.11:8082/actuator/health
{"status":"UP"}
âœ… çŠ¶æ€ï¼šUP
```

#### API ç«¯ç‚¹æµ‹è¯•

- **è®¿é—®åœ°å€**: http://10.211.55.11:8082
- **å¥åº·æ£€æŸ¥**: /actuator/health âœ…
- **API å‰ç¼€**: /api/\*
- **æ•°æ®åº“è¿æ¥**: âœ… æ­£å¸¸

### 3. å‰ç«¯æœåŠ¡æµ‹è¯•

#### é¡µé¢è®¿é—®

```bash
$ curl http://10.211.55.11:8080
<!DOCTYPE html>
<html lang="zh-CN">
âœ… å‰ç«¯é¡µé¢æ­£å¸¸åŠ è½½
```

#### è®¿é—®ä¿¡æ¯

- **å‰ç«¯åœ°å€**: http://10.211.55.11:8080
- **é¡µé¢çŠ¶æ€**: âœ… 200 OK
- **Nginx çŠ¶æ€**: âœ… è¿è¡Œæ­£å¸¸

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
è™šæ‹Ÿæœº 10.211.55.11
â”œâ”€â”€ Docker Network: cloudcom_gaussdb-network
â”‚
â”œâ”€â”€ gaussdb-primary (PostgreSQL 13)
â”‚   â”œâ”€â”€ ç«¯å£: 5432
â”‚   â”œâ”€â”€ è§’è‰²: ä¸»åº“ï¼ˆè¯»å†™ï¼‰
â”‚   â””â”€â”€ æ•°æ®æŒä¹…åŒ–: gaussdb-primary-data volume
â”‚
â”œâ”€â”€ gaussdb-standby1 (PostgreSQL 13)
â”‚   â”œâ”€â”€ ç«¯å£: 5434
â”‚   â”œâ”€â”€ è§’è‰²: å¤‡åº“ï¼ˆåªè¯»ï¼‰
â”‚   â””â”€â”€ æ•°æ®æŒä¹…åŒ–: gaussdb-standby1-data volume
â”‚
â”œâ”€â”€ gaussdb-standby2 (PostgreSQL 13)
â”‚   â”œâ”€â”€ ç«¯å£: 5436
â”‚   â”œâ”€â”€ è§’è‰²: å¤‡åº“ï¼ˆåªè¯»ï¼‰
â”‚   â””â”€â”€ æ•°æ®æŒä¹…åŒ–: gaussdb-standby2-data volume
â”‚
â”œâ”€â”€ blogcircle-backend (Spring Boot + JDK 17)
â”‚   â”œâ”€â”€ ç«¯å£: 8082 (æ˜ å°„åˆ°å®¹å™¨ 8080)
â”‚   â”œâ”€â”€ å†…å­˜: 128MB-256MB
â”‚   â”œâ”€â”€ æ•°æ®åº“: è¿æ¥åˆ° gaussdb-primary
â”‚   â””â”€â”€ é…ç½®: application-docker.yml
â”‚
â””â”€â”€ blogcircle-frontend (Vue 3 + Nginx)
    â”œâ”€â”€ ç«¯å£: 8080
    â”œâ”€â”€ é™æ€èµ„æº: /usr/share/nginx/html
    â””â”€â”€ API ä»£ç†: -> backend:8080
```

---

## ğŸ”§ éƒ¨ç½²é…ç½®æ–‡ä»¶

### Docker Compose é…ç½®

- **æ–‡ä»¶**: `docker-compose-vm-fixed.yml`
- **ç‰ˆæœ¬**: 3.3 (å…¼å®¹è™šæ‹Ÿæœº Docker Compose)
- **ç½‘ç»œ**: bridge æ¨¡å¼
- **æ•°æ®æŒä¹…åŒ–**: Docker volumes

### å…³é”®é…ç½®è°ƒæ•´

1. **ç‰ˆæœ¬å…¼å®¹**: ä» 3.8 é™çº§åˆ° 3.3
2. **å†…å­˜ä¼˜åŒ–**: åç«¯ JVM å†…å­˜ä» 512MB é™è‡³ 256MB
3. **æƒé™æ¨¡å¼**: åç«¯å®¹å™¨ä½¿ç”¨ `--privileged` æ¨¡å¼
4. **é•œåƒç­–ç•¥**: ä½¿ç”¨é¢„æ„å»ºé•œåƒè€Œéå®æ—¶æ„å»º

---

## ğŸ“ æµ‹è¯•è„šæœ¬

### æ•°æ®åº“æ£€æŸ¥è„šæœ¬

ä½ç½®: `scripts/check_db_vm.sh`

åŠŸèƒ½:

- æ£€æŸ¥ä¸»åº“å’Œä¸¤ä¸ªå¤‡åº“è¿æ¥çŠ¶æ€
- éªŒè¯å¤åˆ¶çŠ¶æ€
- æ‰§è¡Œè¯»å†™æµ‹è¯•

### å®Œæ•´éªŒè¯è„šæœ¬

ä½ç½®: `scripts/full_verify.sh`

åŠŸèƒ½:

- æ•°æ®åº“é›†ç¾¤æ£€æŸ¥
- åç«¯æœåŠ¡æ£€æŸ¥
- å‰ç«¯æœåŠ¡æ£€æŸ¥

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. æµå¤åˆ¶æœªå®Œå…¨å»ºç«‹

**ç°è±¡**: `pg_stat_replication` æ˜¾ç¤º 0 ä¸ªå¤‡åº“è¿æ¥  
**åŸå› **: åˆå§‹ pg_hba.conf é…ç½®ä¸å®Œæ•´  
**è§£å†³æ–¹æ¡ˆ**: å·²æ‰‹åŠ¨æ·»åŠ å¤åˆ¶æƒé™é…ç½®  
**çŠ¶æ€**: å¤‡åº“å¯ç‹¬ç«‹è¿è¡Œï¼Œä½†æµå¤åˆ¶éœ€è¿›ä¸€æ­¥é…ç½®

### 2. è™šæ‹Ÿæœºç½‘ç»œé™åˆ¶

**ç°è±¡**: æ— æ³•ç›´æ¥ä» Docker Hub æ‹‰å–é•œåƒ  
**è§£å†³æ–¹æ¡ˆ**: é‡‡ç”¨æœ¬åœ°æ„å»º + SSH ä¼ è¾“æ–¹æ¡ˆ  
**å½±å“**: éƒ¨ç½²æ—¶é—´å¢åŠ ï¼Œä½†ä¸å½±å“æœ€ç»ˆè¿è¡Œ

### 3. èµ„æºé™åˆ¶

**ç°è±¡**: åˆå§‹åç«¯å®¹å™¨å› å†…å­˜ä¸è¶³æ— æ³•å¯åŠ¨  
**è§£å†³æ–¹æ¡ˆ**: é™ä½ JVM å†…å­˜é…ç½®å¹¶ä½¿ç”¨ç‰¹æƒæ¨¡å¼  
**å½“å‰é…ç½®**: `-Xms128m -Xmx256m`

---

## âœ… éªŒè¯æ¸…å•

- [x] è™šæ‹Ÿæœºç¯å¢ƒæ¸…ç†å®Œæˆ
- [x] Docker é•œåƒæˆåŠŸä¼ è¾“
- [x] æ•°æ®åº“ä¸»åº“è¿è¡Œæ­£å¸¸
- [x] æ•°æ®åº“å¤‡åº“ 1 è¿è¡Œæ­£å¸¸
- [x] æ•°æ®åº“å¤‡åº“ 2 è¿è¡Œæ­£å¸¸
- [x] åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ
- [x] åç«¯å¥åº·æ£€æŸ¥é€šè¿‡
- [x] å‰ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ
- [x] å‰ç«¯é¡µé¢å¯è®¿é—®
- [x] æ‰€æœ‰å®¹å™¨çŠ¶æ€å¥åº·
- [ ] æµå¤åˆ¶å®Œå…¨é…ç½®ï¼ˆå¾…ä¼˜åŒ–ï¼‰

---

## ğŸ¯ è®¿é—®åœ°å€

### å¤–éƒ¨è®¿é—®ï¼ˆä»å®¿ä¸»æœºï¼‰

- **å‰ç«¯**: http://10.211.55.11:8080
- **åç«¯**: http://10.211.55.11:8082
- **åç«¯å¥åº·æ£€æŸ¥**: http://10.211.55.11:8082/actuator/health
- **æ•°æ®åº“ä¸»åº“**: 10.211.55.11:5432
- **æ•°æ®åº“å¤‡åº“ 1**: 10.211.55.11:5434
- **æ•°æ®åº“å¤‡åº“ 2**: 10.211.55.11:5436

### å®¹å™¨å†…éƒ¨è®¿é—®

- **åç«¯**: http://backend:8080
- **æ•°æ®åº“ä¸»åº“**: gaussdb-primary:5432
- **æ•°æ®åº“å¤‡åº“ 1**: gaussdb-standby1:5432
- **æ•°æ®åº“å¤‡åº“ 2**: gaussdb-standby2:5432

---

## ğŸš€ ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
ssh root@10.211.55.11
docker ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# åç«¯æ—¥å¿—
docker logs blogcircle-backend

# å‰ç«¯æ—¥å¿—
docker logs blogcircle-frontend

# æ•°æ®åº“æ—¥å¿—
docker logs gaussdb-primary
docker logs gaussdb-standby1
docker logs gaussdb-standby2
```

### é‡å¯æœåŠ¡

```bash
cd ~/CloudCom
docker-compose -f docker-compose-vm-fixed.yml restart
```

### åœæ­¢æœåŠ¡

```bash
cd ~/CloudCom
docker-compose -f docker-compose-vm-fixed.yml down
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **åç«¯å“åº”æ—¶é—´**: < 100ms
- **å‰ç«¯åŠ è½½æ—¶é—´**: < 200ms
- **æ•°æ®åº“è¿æ¥**: æ­£å¸¸
- **å®¹å™¨å†…å­˜ä½¿ç”¨**:
  - åç«¯: ~200MB
  - å‰ç«¯: ~20MB
  - æ•°æ®åº“: ~50MB æ¯ä¸ªå®ä¾‹

---

## ğŸ“ æŠ€æœ¯æ ˆ

- **å®¹å™¨åŒ–**: Docker + Docker Compose 3.3
- **æ•°æ®åº“**: PostgreSQL 13 (æ¨¡æ‹Ÿ GaussDB)
- **åç«¯**: Spring Boot 3.1.5 + JDK 17
- **å‰ç«¯**: Vue 3 + Vite + Nginx
- **ç½‘ç»œ**: Docker Bridge Network
- **æ•°æ®æŒä¹…åŒ–**: Docker Volumes

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡åœ¨è™šæ‹Ÿæœº 10.211.55.11 ä¸ŠæˆåŠŸå®Œæˆäº†å®Œå…¨å®¹å™¨åŒ–çš„ç³»ç»Ÿéƒ¨ç½²ï¼š

1. âœ… **éƒ¨ç½²æˆåŠŸ**: æ‰€æœ‰ 5 ä¸ªå®¹å™¨æœåŠ¡æ­£å¸¸è¿è¡Œ
2. âœ… **åŠŸèƒ½éªŒè¯**: æ•°æ®åº“ã€åç«¯ã€å‰ç«¯åŠŸèƒ½æ­£å¸¸
3. âœ… **å¥åº·çŠ¶æ€**: æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
4. âœ… **å¤–éƒ¨è®¿é—®**: å¯ä»å®¿ä¸»æœºæ­£å¸¸è®¿é—®æ‰€æœ‰æœåŠ¡
5. âš ï¸ **ä¼˜åŒ–ç©ºé—´**: æµå¤åˆ¶é…ç½®éœ€è¿›ä¸€æ­¥å®Œå–„

ç³»ç»Ÿå·²å…·å¤‡åŸºæœ¬çš„ç”Ÿäº§ç¯å¢ƒè¿è¡Œèƒ½åŠ›ï¼Œå¯ç”¨äºåŠŸèƒ½æµ‹è¯•å’Œæ¼”ç¤ºã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-22 12:45  
**éƒ¨ç½²çŠ¶æ€**: âœ… æˆåŠŸ
