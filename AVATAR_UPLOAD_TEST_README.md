# 头像上传功能测试文档

## 📋 测试概述

本测试套件用于验证个人主页的头像上传功能，包括上传流程、错误处理、UI交互等场景。

---

## 🧪 测试用例

### 1. **成功上传头像** (`成功上传头像`)
- **测试步骤：**
  1. 登录用户
  2. 导航到个人主页 (`/profile`)
  3. 点击头像区域
  4. 选择图片文件上传
  5. 验证上传API调用
  6. 验证用户信息更新API调用
  7. 验证成功提示消息
  8. 验证头像URL更新

- **预期结果：**
  - ✅ 上传API返回200状态码
  - ✅ 用户信息更新API返回200状态码
  - ✅ 显示"头像上传成功"提示
  - ✅ 头像URL更新为新上传的图片

---

### 2. **头像hover显示上传提示** (`头像hover显示上传提示`)
- **测试步骤：**
  1. 登录用户
  2. 导航到个人主页
  3. Hover到头像区域
  4. 检查遮罩层显示

- **预期结果：**
  - ✅ 显示上传提示遮罩层
  - ✅ 显示"点击上传"或"更换头像"文字

---

### 3. **点击头像触发文件选择** (`点击头像触发文件选择`)
- **测试步骤：**
  1. 登录用户
  2. 导航到个人主页
  3. 点击头像区域
  4. 检查文件input是否存在

- **预期结果：**
  - ✅ 文件input元素存在
  - ✅ input的accept属性为`image/*`

---

### 4. **头像上传文件类型验证** (`头像上传文件类型验证`)
- **测试步骤：**
  1. 登录用户
  2. 导航到个人主页
  3. 尝试上传非图片文件（如.txt）

- **预期结果：**
  - ✅ 显示错误提示："请选择图片文件"
  - ✅ 上传被拒绝

---

### 5. **头像上传文件大小验证** (`头像上传文件大小验证`)
- **测试步骤：**
  1. 登录用户
  2. 导航到个人主页
  3. 尝试上传超大文件（>5MB）

- **预期结果：**
  - ✅ 显示错误提示："图片大小不能超过5MB"
  - ✅ 上传被拒绝

---

### 6. **头像上传后更新显示** (`头像上传后更新显示`)
- **测试步骤：**
  1. 登录用户
  2. 导航到个人主页
  3. 记录初始头像URL
  4. 模拟上传成功
  5. 验证头像URL更新

- **预期结果：**
  - ✅ 头像URL更新为新URL
  - ✅ 头像图片正确显示

---

### 7. **头像上传loading状态** (`头像上传loading状态`)
- **测试步骤：**
  1. 登录用户
  2. 导航到个人主页
  3. 触发上传
  4. 检查loading状态

- **预期结果：**
  - ✅ 显示loading动画
  - ✅ 头像区域显示加载状态

---

## 🚀 运行测试

### 方法1: 使用测试脚本（推荐）

```bash
# 在项目根目录运行
./test-avatar-upload.sh
```

### 方法2: 直接使用 Playwright

```bash
# 进入前端目录
cd frontend

# 运行头像上传测试
npx playwright test tests/e2e/avatar.spec.ts

# 运行并显示UI（调试模式）
npx playwright test tests/e2e/avatar.spec.ts --ui

# 运行并查看报告
npx playwright test tests/e2e/avatar.spec.ts --reporter=html
npx playwright show-report
```

### 方法3: 运行所有E2E测试

```bash
cd frontend
npx playwright test
```

---

## 📊 查看测试报告

测试完成后，可以使用以下命令查看详细的HTML报告：

```bash
cd frontend
npx playwright show-report
```

报告包含：
- ✅ 测试用例执行状态
- 📸 失败用例的截图
- 🎥 失败用例的视频录制
- 📝 详细的错误信息

---

## 🔧 测试前置条件

### 1. 环境要求
- ✅ Node.js 已安装
- ✅ 前端依赖已安装 (`npm install`)
- ✅ Playwright 已安装 (`npx playwright install chromium`)
- ✅ 后端服务正在运行 (`http://localhost:8080`)
- ✅ 前端服务正在运行 (`http://localhost:5173`)

### 2. 测试数据
- ✅ 测试用户账号：`admin` / `admin123`
- ✅ 测试图片文件：`tests/e2e/fixtures/test-image.jpg`

### 3. 数据库状态
- ✅ 用户表存在 `avatar` 字段
- ✅ 上传目录可写 (`backend/uploads/`)

---

## 🐛 常见问题

### 1. 测试失败：找不到文件input
**原因：** 选择器不正确或元素未加载  
**解决：** 增加等待时间，检查DOM结构

### 2. 测试失败：文件上传被阻止
**原因：** 浏览器安全限制  
**解决：** 使用JavaScript直接设置files属性（测试中已实现）

### 3. 测试失败：API超时
**原因：** 后端服务未启动或响应慢  
**解决：** 确保后端服务运行，增加超时时间

### 4. 测试失败：头像未更新
**原因：** 前端状态未刷新  
**解决：** 增加等待时间，检查用户信息刷新逻辑

---

## 📝 测试覆盖率

当前测试覆盖以下功能点：

| 功能点 | 测试覆盖 | 状态 |
|--------|---------|------|
| 点击头像触发上传 | ✅ | 已测试 |
| 文件选择对话框 | ✅ | 已测试 |
| 文件类型验证 | ✅ | 已测试 |
| 文件大小验证 | ✅ | 已测试 |
| 上传API调用 | ✅ | 已测试 |
| 用户信息更新API | ✅ | 已测试 |
| Loading状态显示 | ✅ | 已测试 |
| 成功提示消息 | ✅ | 已测试 |
| 头像URL更新 | ✅ | 已测试 |
| Hover提示显示 | ✅ | 已测试 |

---

## 🔄 持续集成

测试可以在CI/CD流程中自动运行：

```yaml
# GitHub Actions 示例
- name: Run Avatar Upload Tests
  run: |
    cd frontend
    npx playwright test tests/e2e/avatar.spec.ts
```

---

## 📚 相关文档

- [Playwright 官方文档](https://playwright.dev/)
- [E2E测试最佳实践](./tests/e2e/README.md)
- [头像上传功能说明](../PROFILE_FIXES_COMPLETE.md)

---

**测试文件位置：** `frontend/tests/e2e/avatar.spec.ts`  
**测试脚本位置：** `test-avatar-upload.sh`  
**最后更新：** 2025-11-03

