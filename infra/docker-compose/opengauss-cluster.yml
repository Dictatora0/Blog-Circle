version: "3.8"

services:
  # openGauss 主库
  opengauss-primary:
    image: enmotech/opengauss-lite:latest
    container_name: opengauss-primary
    hostname: ${OPENGAUSS_PRIMARY_HOST:-opengauss-primary}
    env_file:
      - .env
    environment:
      GS_PASSWORD: ${OPENGAUSS_PASSWORD}
      GS_NODENAME: ${OPENGAUSS_PRIMARY_NODENAME:-gaussdb_primary}
      GS_PORT: ${OPENGAUSS_PRIMARY_PORT}
    volumes:
      - opengauss-primary-data:/var/lib/opengauss
    ports:
      - "${HOST_PRIMARY_DB_PORT:-5432}:${OPENGAUSS_PRIMARY_PORT:-5432}"
    networks:
      opengauss-network:
        ipv4_address: 172.26.0.10
    healthcheck:
      test:
        - CMD-SHELL
        - ps aux | grep gaussdb | grep -v grep || exit 1
      interval: 15s
      timeout: 10s
      retries: 10
    restart: unless-stopped

  # openGauss 备库1
  opengauss-standby1:
    image: enmotech/opengauss-lite:latest
    container_name: opengauss-standby1
    hostname: ${OPENGAUSS_STANDBY1_HOST:-opengauss-standby1}
    env_file:
      - .env
    environment:
      GS_PASSWORD: ${OPENGAUSS_PASSWORD}
      GS_NODENAME: ${OPENGAUSS_STANDBY1_NODENAME:-gaussdb_standby1}
      GS_PORT: ${OPENGAUSS_STANDBY1_PORT}
    volumes:
      - opengauss-standby1-data:/var/lib/opengauss
    ports:
      - "${HOST_STANDBY1_DB_PORT:-5434}:${OPENGAUSS_STANDBY1_PORT:-15432}"
    depends_on:
      opengauss-primary:
        condition: service_healthy
    networks:
      opengauss-network:
        ipv4_address: 172.26.0.11
    healthcheck:
      test:
        - CMD-SHELL
        - ps aux | grep gaussdb | grep -v grep || exit 1
      interval: 15s
      timeout: 10s
      retries: 10
    restart: unless-stopped

  # openGauss 备库2
  opengauss-standby2:
    image: enmotech/opengauss-lite:latest
    container_name: opengauss-standby2
    hostname: ${OPENGAUSS_STANDBY2_HOST:-opengauss-standby2}
    env_file:
      - .env
    environment:
      GS_PASSWORD: ${OPENGAUSS_PASSWORD}
      GS_NODENAME: ${OPENGAUSS_STANDBY2_NODENAME:-gaussdb_standby2}
      GS_PORT: ${OPENGAUSS_STANDBY2_PORT}
    volumes:
      - opengauss-standby2-data:/var/lib/opengauss
    ports:
      - "${HOST_STANDBY2_DB_PORT:-5436}:${OPENGAUSS_STANDBY2_PORT:-25432}"
    depends_on:
      opengauss-primary:
        condition: service_healthy
    networks:
      opengauss-network:
        ipv4_address: 172.26.0.12
    healthcheck:
      test:
        - CMD-SHELL
        - ps aux | grep gaussdb | grep -v grep || exit 1
      interval: 15s
      timeout: 10s
      retries: 10
    restart: unless-stopped

  # 后端服务
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: blogcircle-backend
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-opengauss-cluster}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:opengauss://${OPENGAUSS_PRIMARY_HOST:-opengauss-primary}:${OPENGAUSS_PRIMARY_PORT:-5432}/${OPENGAUSS_DATABASE:-blog_db}}
      SPRING_DATASOURCE_USERNAME: ${OPENGAUSS_USERNAME:-bloguser}
      SPRING_DATASOURCE_PASSWORD: ${OPENGAUSS_PASSWORD:-Blog@2025}
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.opengauss.Driver
      SERVER_PORT: ${BACKEND_CONTAINER_PORT:-8080}
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS:- -Xms128m -Xmx256m -XX:+UseG1GC}
    volumes:
      - backend-uploads:/app/uploads
    ports:
      - "${HOST_BACKEND_PORT:-8082}:${BACKEND_CONTAINER_PORT:-8080}"
    depends_on:
      opengauss-primary:
        condition: service_healthy
      opengauss-standby1:
        condition: service_started
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:${BACKEND_CONTAINER_PORT:-8080}/actuator/health
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - opengauss-network
    restart: unless-stopped

  # 前端服务
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
    container_name: blogcircle-frontend
    env_file:
      - .env
    environment:
      BACKEND_URL: ${FRONTEND_BACKEND_URL:-http://backend:8080}
    ports:
      - "${HOST_FRONTEND_PORT:-8080}:${FRONTEND_CONTAINER_PORT:-8080}"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --tries=1
        - --spider
        - http://localhost:${FRONTEND_CONTAINER_PORT:-8080}/
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - opengauss-network
    restart: unless-stopped

volumes:
  opengauss-primary-data:
    driver: local
  opengauss-standby1-data:
    driver: local
  opengauss-standby2-data:
    driver: local
  backend-uploads:
    driver: local

networks:
  opengauss-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16
