name: Blog Circle Test CI

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: lying
          POSTGRES_PASSWORD: 456789
          POSTGRES_DB: blog_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and Test Backend
        run: |
          cd backend
          mvn clean test -B
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/blog_db
          SPRING_DATASOURCE_USERNAME: lying
          SPRING_DATASOURCE_PASSWORD: 456789

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/target/surefire-reports/

  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: lying
          POSTGRES_PASSWORD: 456789
          POSTGRES_DB: blog_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Initialize database
        run: |
          # å®‰è£…PostgreSQLå®¢æˆ·ç«¯
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          
          # åˆå§‹åŒ–æ•°æ®åº“
          PGPASSWORD=456789 psql -h localhost -U lying -d blog_db -f backend/src/main/resources/db/init.sql || true
          
          # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆæ·»åŠ cover_imageå­—æ®µï¼‰
          if [ -f backend/src/main/resources/db/migration_add_cover_image.sql ]; then
            PGPASSWORD=456789 psql -h localhost -U lying -d blog_db -f backend/src/main/resources/db/migration_add_cover_image.sql || true
          fi
          
          # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆåˆ›å»ºå¥½å‹å…³ç³»è¡¨ï¼‰
          if [ -f backend/src/main/resources/db/friendship.sql ]; then
            PGPASSWORD=456789 psql -h localhost -U lying -d blog_db -f backend/src/main/resources/db/friendship.sql || true
          fi
        env:
          PGPASSWORD: 456789

      - name: Start backend server
        run: |
          cd backend
          mvn clean package -DskipTests -q
          java -jar target/blog-system-1.0.0.jar > ../backend.log 2>&1 &
          echo $! > ../backend.pid
          # ç­‰å¾…åç«¯å®Œå…¨å¯åŠ¨ï¼ˆåŒ…æ‹¬ API å¯ç”¨ï¼‰
          echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
          for i in {1..60}; do
            if curl -f http://localhost:8080/ > /dev/null 2>&1; then
              echo "åç«¯æœåŠ¡å·²å¯åŠ¨"
              # å†æ¬¡ç­‰å¾…ç¡®ä¿ API å®Œå…¨å°±ç»ª
              sleep 3
              # æµ‹è¯•ç™»å½• API æ˜¯å¦å¯ç”¨
              if curl -f -X POST http://localhost:8080/api/auth/login \
                -H "Content-Type: application/json" \
                -d '{"username":"admin","password":"admin123"}' > /dev/null 2>&1; then
                echo "åç«¯ API å·²å°±ç»ª"
                break
              fi
            fi
            if [ $i -eq 60 ]; then
              echo "åç«¯å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              tail -n 50 ../backend.log || true
              exit 1
            fi
            sleep 2
          done
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/blog_db
          SPRING_DATASOURCE_USERNAME: lying
          SPRING_DATASOURCE_PASSWORD: 456789

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Install Playwright browsers
        run: |
          cd frontend
          npx playwright install --with-deps chromium

      - name: Start frontend server
        run: |
          cd frontend
          npm run dev > ../frontend.log 2>&1 &
          echo $! > ../frontend.pid
          # ç­‰å¾…å‰ç«¯å¯åŠ¨
          echo "ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨..."
          for i in {1..30}; do
            if curl -f http://localhost:5173 > /dev/null 2>&1; then
              echo "å‰ç«¯æœåŠ¡å·²å¯åŠ¨"
              sleep 2
              break
            fi
            if [ $i -eq 30 ]; then
              echo "å‰ç«¯å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              tail -n 50 ../frontend.log || true
              exit 1
            fi
            sleep 1
          done
        env:
          CI: true

      - name: Run unit tests
        run: |
          cd frontend
          npm run test

      - name: Run E2E tests - New Features (Avatar & Profile)
        run: |
          cd frontend
          echo "è¿è¡Œæ–°åŠŸèƒ½æµ‹è¯•ï¼šå¤´åƒä¸Šä¼ å’Œä¸ªäººä¸»é¡µ"
          npx playwright test tests/e2e/avatar.spec.ts tests/e2e/profile.spec.ts --reporter=list,html
        env:
          CI: true
          BASE_URL: http://localhost:5173
          API_BASE_URL: http://localhost:8080/api
        continue-on-error: true

      - name: Run E2E tests - Friends System
        run: |
          cd frontend
          echo "è¿è¡Œå¥½å‹ç³»ç»Ÿæµ‹è¯•ï¼šå¥½å‹ç®¡ç†å’Œå¥½å‹æ—¶é—´çº¿"
          npx playwright test tests/e2e/friends.spec.ts tests/e2e/timeline.spec.ts --reporter=list,html
        env:
          CI: true
          BASE_URL: http://localhost:5173
          API_BASE_URL: http://localhost:8080/api
        continue-on-error: true

      - name: Run E2E tests - All Tests
        run: |
          cd frontend
          echo "è¿è¡Œæ‰€æœ‰E2Eæµ‹è¯•"
          npx playwright test --reporter=list,html
        env:
          CI: true
          BASE_URL: http://localhost:5173
          API_BASE_URL: http://localhost:8080/api
        continue-on-error: true

      - name: Stop servers
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
          fi

      - name: Upload test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: frontend/test-results/
          retention-days: 7

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos
          path: frontend/test-results/**/*.webm
          retention-days: 7

      - name: Upload server logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: |
            backend.log
            frontend.log

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    if: always()
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts

      - name: Check test results
        id: test_results
        run: |
          echo "========================================="
          echo "          æµ‹è¯•ç»“æœæ€»ç»“"
          echo "========================================="
          echo ""
          echo "Backend tests: ${{ needs.backend-test.result }}"
          echo "Frontend tests: ${{ needs.frontend-test.result }}"
          echo ""
          
          # æ£€æŸ¥åç«¯æµ‹è¯•ç»“æœ
          if [ "${{ needs.backend-test.result }}" != "success" ]; then
            echo "âŒ åç«¯æµ‹è¯•å¤±è´¥"
            BACKEND_FAILED=true
          else
            echo "âœ… åç«¯æµ‹è¯•é€šè¿‡"
          fi
          
          # æ£€æŸ¥å‰ç«¯æµ‹è¯•ç»“æœ
          if [ "${{ needs.frontend-test.result }}" != "success" ]; then
            echo "âŒ å‰ç«¯æµ‹è¯•å¤±è´¥"
            FRONTEND_FAILED=true
          else
            echo "âœ… å‰ç«¯æµ‹è¯•é€šè¿‡"
          fi
          
          echo ""
          echo "========================================="
          echo "æµ‹è¯•æŠ¥å‘Šå’Œæˆªå›¾å·²ä¸Šä¼ åˆ°Artifacts"
          echo "========================================="
          
          # å¦‚æœæœ‰æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºå¹¶è¿”å›é”™è¯¯ç 
          if [ "${{ needs.backend-test.result }}" != "success" ] || [ "${{ needs.frontend-test.result }}" != "success" ]; then
            echo "âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Auto merge dev to main (if tests pass)
        if: |
          github.ref == 'refs/heads/dev' && 
          steps.test_results.outputs.tests_passed == 'true' &&
          github.event_name == 'push'
        run: |
          echo "æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡åˆå¹¶ dev åˆ° main..."
          
          # é…ç½®git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # åˆ‡æ¢åˆ°mainåˆ†æ”¯
          git checkout main
          git pull origin main
          
          # åˆå¹¶devåˆ†æ”¯
          git merge dev --no-edit -m "chore: è‡ªåŠ¨åˆå¹¶ dev åˆ° main (æµ‹è¯•é€šè¿‡)"
          
          # æ¨é€åˆ°mainåˆ†æ”¯
          git push origin main
          
          echo "âœ… dev åˆ†æ”¯å·²æˆåŠŸåˆå¹¶åˆ° main åˆ†æ”¯"

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const backendResult = '${{ needs.backend-test.result }}';
            const frontendResult = '${{ needs.frontend-test.result }}';
            
            const comment = `## ğŸ§ª æµ‹è¯•ç»“æœ
            
            | æµ‹è¯•ç±»å‹ | çŠ¶æ€ |
            |---------|------|
            | åç«¯æµ‹è¯• | ${backendResult === 'success' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'} |
            | å‰ç«¯æµ‹è¯• | ${frontendResult === 'success' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'} |
            
            ### ğŸ“Š æµ‹è¯•è¦†ç›–
            
            - âœ… å¤´åƒä¸Šä¼ åŠŸèƒ½æµ‹è¯• (\`avatar.spec.ts\`)
            - âœ… ä¸ªäººä¸»é¡µåŠŸèƒ½æµ‹è¯• (\`profile.spec.ts\`) - å°é¢ã€å¸ƒå±€ã€åŠ¨æ€æ˜¾ç¤º
            - âœ… å¥½å‹ç³»ç»ŸåŠŸèƒ½æµ‹è¯• (\`friends.spec.ts\`) - æœç´¢ã€æ·»åŠ ã€ç®¡ç†å¥½å‹
            - âœ… å¥½å‹æ—¶é—´çº¿æµ‹è¯• (\`timeline.spec.ts\`) - æŸ¥çœ‹å¥½å‹åŠ¨æ€ã€ç‚¹èµè¯„è®º
            - âœ… ç”¨æˆ·ç™»å½•æµ‹è¯•
            - âœ… åŠ¨æ€å‘å¸ƒæµ‹è¯•
            - âœ… è¯„è®ºå’Œç‚¹èµæµ‹è¯•
            
            ### ğŸ“ æµ‹è¯•æŠ¥å‘Š
            
            è¯¦ç»†æµ‹è¯•æŠ¥å‘Šå’Œæˆªå›¾å·²ä¸Šä¼ åˆ° [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *è‡ªåŠ¨ç”Ÿæˆäº ${{ github.run_id }}*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

