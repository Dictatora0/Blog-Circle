# GaussDB 数据同步方案

## 概述

由于当前 GaussDB 集群使用的是 **single_node 独立模式**（三个独立实例），数据不会自动同步。本文档介绍了几种简易的数据同步方案。

## 🎯 方案对比

| 方案             | 优点               | 缺点                   | 适用场景             |
| ---------------- | ------------------ | ---------------------- | -------------------- |
| **应用层双写**   | 实时同步、实现简单 | 性能开销较大           | 演示、测试环境       |
| **定期同步脚本** | 性能开销小、灵活   | 非实时同步             | 数据量大、更新不频繁 |
| **真正流复制**   | 原生支持、性能最佳 | 配置复杂、需要重建集群 | 生产环境             |

---

## ✅ 方案 1：应用层双写（已实现）

### 原理

在应用写入主库的同时，也写入所有备库，模拟主备同步。

### 优点

- ✅ 实时同步
- ✅ 实现简单
- ✅ 适合课程演示

### 使用方法

#### 测试脚本（自动双写）

```bash
# 在虚拟机上运行
ssh root@10.211.55.11
cd ~/CloudCom
./scripts/test-gaussdb-readwrite.sh
```

测试脚本已实现：

- ✅ 主库写入后自动同步到所有备库
- ✅ 验证数据一致性
- ✅ 自动清理测试数据

#### 应用层实现示例

```java
// Spring Boot 应用中的双写示例
@Transactional
public void savePost(Post post) {
    // 1. 写入主库
    primaryDataSource.save(post);

    // 2. 异步写入备库
    CompletableFuture.runAsync(() -> {
        standby1DataSource.save(post);
        standby2DataSource.save(post);
    });
}
```

---

## 📦 方案 2：定期同步脚本（已实现）

### 原理

定期从主库导出数据并导入到备库，类似于数据快照同步。

### 优点

- ✅ 性能开销小
- ✅ 适合批量同步
- ✅ 可按需执行

### 使用方法

```bash
# 在虚拟机上运行
ssh root@10.211.55.11
cd ~/CloudCom

# 同步所有业务表
./scripts/sync-gaussdb-data.sh

# 可以添加到 cron 定时任务
# 例如：每小时同步一次
# 0 * * * * /root/CloudCom/scripts/sync-gaussdb-data.sh
```

### 同步内容

脚本会同步以下表：

- `users` - 用户表
- `posts` - 帖子表
- `comments` - 评论表
- `likes` - 点赞表
- `friendship` - 好友关系表
- `statistics` - 统计表
- `access_logs` - 访问日志表

### 输出示例

```
=========================================
   GaussDB 数据同步工具
=========================================

▶ 同步表: users
  ✓ 已同步 14 行数据
▶ 同步表: posts
  ✓ 已同步 11 行数据
...
```

---

## 🔧 方案 3：真正的流复制（复杂）

### 原理

使用 openGauss 的原生流复制功能，需要配置 CM（Cluster Manager）。

### 优点

- ✅ 原生支持
- ✅ 性能最佳
- ✅ 自动故障转移

### 缺点

- ❌ 配置复杂（需要 2-3 小时）
- ❌ 需要重建集群
- ❌ 需要学习 openGauss CM 工具

### 配置步骤（概要）

1. 停止所有实例
2. 配置主库 `pg_hba.conf` 和 `postgresql.conf`
3. 创建复制用户
4. 使用 `gs_basebackup` 克隆主库到备库
5. 配置备库 `recovery.conf` 或 `standby.signal`
6. 以 Primary/Standby 模式启动
7. 验证复制连接

**注意**：由于时间限制和课程演示需求，建议使用方案 1 或方案 2。

---

## 📊 性能对比

| 方案       | 写入延迟     | CPU 开销 | 网络开销 | 数据一致性 |
| ---------- | ------------ | -------- | -------- | ---------- |
| 应用层双写 | 高（同步写） | 中       | 高       | 强一致     |
| 定期同步   | 低           | 低       | 中       | 最终一致   |
| 流复制     | 低           | 低       | 低       | 强一致     |

---

## 🎬 演示建议

### 课程录制

推荐使用 **方案 1（应用层双写）** + **方案 2（定期同步）**：

1. **初始化数据**：运行 `sync-gaussdb-data.sh` 同步现有数据
2. **测试演示**：运行 `test-gaussdb-readwrite.sh` 展示实时双写
3. **说明架构**：
   - 三个独立 GaussDB 实例
   - 应用层实现读写分离
   - 双写保证数据一致性

### 演示脚本

```bash
# 1. 同步现有数据
./scripts/sync-gaussdb-data.sh

# 2. 运行读写测试
./scripts/test-gaussdb-readwrite.sh

# 3. 验证三个实例数据一致
ssh root@10.211.55.11
su - omm
gsql -p 5432 -d blog_db -c "SELECT COUNT(*) FROM users;"
gsql -p 5434 -d blog_db -c "SELECT COUNT(*) FROM users;"
gsql -p 5436 -d blog_db -c "SELECT COUNT(*) FROM users;"
```

---

## 📝 总结

### 当前实现状态

- ✅ **应用层双写**：测试脚本已实现
- ✅ **定期同步**：同步脚本已实现
- ✅ **数据验证**：自动验证数据一致性
- ⏳ **流复制**：因复杂度暂未实现

### 推荐使用

- **课程演示**：方案 1 + 方案 2
- **日常测试**：方案 2
- **生产环境**：方案 3（需要额外配置）

### 关键优势

1. **简单易用** - 一键执行同步
2. **灵活可控** - 支持手动和自动同步
3. **满足需求** - 足以支持课程演示和测试

---

## 🔗 相关脚本

| 脚本                        | 功能                 | 路径        |
| --------------------------- | -------------------- | ----------- |
| `test-gaussdb-readwrite.sh` | 读写测试（自动双写） | `/scripts/` |
| `sync-gaussdb-data.sh`      | 手动数据同步         | `/scripts/` |
| `start-vm-services.sh`      | 启动所有服务         | `/scripts/` |
| `stop-vm-services.sh`       | 停止所有服务         | `/scripts/` |

---

**更新时间**: 2025-11-08  
**作者**: Blog Circle 开发团队
