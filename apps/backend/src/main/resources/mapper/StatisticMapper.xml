<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloudcom.blog.mapper.StatisticMapper">

    <insert id="insert" parameterType="Statistic">
        INSERT INTO statistics (stat_type, stat_key, stat_value, created_at, updated_at)
        VALUES (#{statType}, #{statKey}, #{statValue}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <update id="update" parameterType="Statistic">
        UPDATE statistics 
        SET stat_value = #{statValue}, updated_at = CURRENT_TIMESTAMP
        WHERE stat_type = #{statType} AND stat_key = #{statKey}
    </update>
    
    <insert id="insertOrUpdate" parameterType="Statistic">
        <!-- openGauss 兼容的 UPSERT 语句 -->
        MERGE INTO statistics AS target
        USING (SELECT 
            #{statType} as stat_type, 
            #{statKey} as stat_key, 
            #{statValue} as stat_value,
            CURRENT_TIMESTAMP as created_at,
            CURRENT_TIMESTAMP as updated_at
        ) AS source
        ON (target.stat_type = source.stat_type AND target.stat_key = source.stat_key)
        WHEN MATCHED THEN
            UPDATE SET 
                stat_value = source.stat_value,
                updated_at = CURRENT_TIMESTAMP
        WHEN NOT MATCHED THEN
            INSERT (stat_type, stat_key, stat_value, created_at, updated_at)
            VALUES (source.stat_type, source.stat_key, source.stat_value, source.created_at, source.updated_at)
    </insert>
    
    <select id="selectOne" resultType="Statistic">
        SELECT * FROM statistics 
        WHERE stat_type = #{param1} AND stat_key = #{param2}
        LIMIT 1
    </select>

    <select id="selectByType" resultType="Statistic">
        SELECT * FROM statistics 
        WHERE stat_type = #{statType}
        ORDER BY stat_value DESC
    </select>

    <select id="selectAll" resultType="Statistic">
        SELECT * FROM statistics 
        ORDER BY stat_type, stat_value DESC
    </select>

    <!-- SQL备用方案：统计用户发文数量 -->
    <select id="selectUserPostCounts" resultType="Statistic">
        SELECT 
            'USER_POST_COUNT' as stat_type,
            CONCAT('user_', author_id) as stat_key,
            COUNT(*) as stat_value
        FROM posts
        GROUP BY author_id
    </select>

    <!-- SQL备用方案：统计文章浏览次数 -->
    <select id="selectPostViewCounts" resultType="Statistic">
        SELECT 
            'POST_VIEW_COUNT' as stat_type,
            CONCAT('post_', id) as stat_key,
            COALESCE(view_count, 0) as stat_value
        FROM posts
        WHERE view_count > 0
    </select>

    <!-- SQL备用方案：统计评论数量 -->
    <select id="selectCommentCounts" resultType="Statistic">
        SELECT 
            'POST_COMMENT_COUNT' as stat_type,
            CONCAT('post_', post_id) as stat_key,
            COUNT(*) as stat_value
        FROM comments
        GROUP BY post_id
    </select>

    <!-- 聚合统计：总动态数 -->
    <select id="countTotalPosts" resultType="long">
        SELECT COUNT(*) FROM posts
    </select>

    <!-- 聚合统计：总浏览量 -->
    <select id="countTotalViews" resultType="long">
        SELECT COALESCE(SUM(view_count), 0) FROM posts
    </select>

    <!-- 聚合统计：总点赞数 -->
    <select id="countTotalLikes" resultType="long">
        SELECT COUNT(*) FROM likes
    </select>

    <!-- 聚合统计：总评论数 -->
    <select id="countTotalComments" resultType="long">
        SELECT COUNT(*) FROM comments
    </select>

    <!-- 聚合统计：总用户数 -->
    <select id="countTotalUsers" resultType="long">
        SELECT COUNT(*) FROM users
    </select>

</mapper>

