# GaussDB 集群测试脚本功能说明

## 概述

`check_gaussdb_cluster.sh` 脚本已完善，提供全面的 GaussDB 一主两备集群测试功能。

## 新增测试功能

### 1. 数据库连接测试

- **功能**: 验证所有节点的数据库连接是否正常
- **测试内容**:
  - 主节点数据库连接
  - 备节点 1 数据库连接
  - 备节点 2 数据库连接
- **验证方式**: 执行 `SELECT version()` 查询

### 2. 数据复制测试

- **功能**: 验证主备节点之间的数据同步功能
- **测试流程**:
  1. 在主节点创建测试表
  2. 插入测试数据
  3. 等待 5 秒让数据复制
  4. 在两个备节点验证数据是否已复制
  5. 自动清理测试数据
- **验证内容**:
  - 表创建成功
  - 数据写入成功
  - 数据复制到备节点 1
  - 数据复制到备节点 2

### 3. 复制延迟测试

- **功能**: 检查主备节点之间的复制延迟
- **测试内容**:
  - 查询 `pg_stat_replication` 视图
  - 计算 WAL 位置差异
  - 检测是否存在显著延迟（MB/GB 级别）
- **判断标准**: 延迟应在正常范围内（字节级别）

### 4. 性能测试

- **功能**: 测试数据库基本查询性能
- **测试流程**:
  1. 创建性能测试表
  2. 插入 1000 行测试数据
  3. 执行 COUNT 查询并测量时间
  4. 自动清理测试表
- **输出**: 查询耗时（毫秒）

### 5. 连接数测试

- **功能**: 检查各节点当前数据库连接数
- **测试内容**:
  - 主节点连接数
  - 备节点 1 连接数
  - 备节点 2 连接数
- **验证方式**: 查询 `pg_stat_activity` 视图

## 测试统计功能

### 自动统计

- **总测试数**: 记录执行的所有测试项
- **通过数**: 成功通过的测试数量
- **失败数**: 失败的测试数量
- **通过率**: 自动计算百分比

### 测试结果记录

每个测试项都会记录：

- ✓ [PASS] 测试名称 - 成功
- ✗ [FAIL] 测试名称 - 失败
- 详细信息（成功/失败原因）

## 报告增强

### 报告结构

```
========================================
  GaussDB 一主两备集群验证报告
========================================
生成时间：YYYY-MM-DD HH:MM:SS
主节点：10.211.55.11
备节点1：10.211.55.14
备节点2：10.211.55.13
数据库端口：5432

节点状态汇总：
[表格形式展示]

复制状态：
[详细信息]

========================================
数据库连接测试
========================================
[测试结果]

========================================
数据复制测试
========================================
[测试结果]

========================================
复制延迟测试
========================================
[测试结果]

========================================
性能测试
========================================
[测试结果]

========================================
连接数测试
========================================
[测试结果]

========================================
测试总结
========================================
总测试数: X
通过: Y
失败: Z
通过率: XX.X%

验证结论：
✓/✗ 状态说明
```

### 终端输出

脚本执行完成后会在终端显示：

- 测试统计摘要
- 整体状态（全部通过/存在失败项）
- 完整报告预览
- 报告文件路径

## 使用方法

### 基本使用

```bash
./check_gaussdb_cluster.sh
```

### 查看历史报告

```bash
ls -lt reports/
cat reports/gaussdb_cluster_report_YYYYMMDD_HHMMSS.txt
```

### 报告保留策略

- 自动保留最新的 3 个报告文件
- 旧报告会被自动清理

## 退出码

- **0**: 所有测试通过
- **1**: 存在失败的测试项

## 配置说明

### 可配置参数

在脚本开头可以修改：

```bash
PRIMARY_IP="10.211.55.11"        # 主节点IP
PRIMARY_ROOT_PWD="747599qw@"     # 主节点密码

STANDBY1_IP="10.211.55.14"       # 备节点1 IP
STANDBY1_ROOT_PWD="747599qw@1"   # 备节点1密码

STANDBY2_IP="10.211.55.13"       # 备节点2 IP
STANDBY2_ROOT_PWD="747599qw@2"   # 备节点2密码

DB_PORT=5432                      # 数据库端口
DB_NAME="postgres"                # 数据库名称
```

## 测试项清单

### 基础检查（原有功能）

- [x] SSH 连接测试
- [x] GaussDB 进程检查
- [x] 端口监听检查
- [x] 数据目录检查
- [x] 磁盘使用检查
- [x] 版本信息检查
- [x] 复制模式检查（pg_is_in_recovery）
- [x] 集群状态检查（gs_om）
- [x] 复制视图检查（pg_stat_replication）

### 新增功能测试

- [x] 数据库连接测试（3 个节点）
- [x] 数据写入测试
- [x] 数据复制验证（2 个备节点）
- [x] 复制延迟测试
- [x] 查询性能测试
- [x] 连接数检查（3 个节点）

## 故障排查

### 如果测试失败

1. 查看详细报告文件
2. 检查失败的具体测试项
3. 根据错误信息进行排查：
   - 连接失败：检查网络和 SSH 配置
   - 数据库连接失败：检查 GaussDB 服务状态
   - 复制失败：检查主备配置和网络
   - 性能异常：检查系统资源

### 常见问题

- **SSH 连接失败**: 确认密码正确，root 登录已启用
- **数据库连接失败**: 确认 GaussDB 服务运行中
- **数据复制失败**: 检查复制配置和网络连通性
- **权限问题**: 确认 omm 用户权限正常

## 最佳实践

1. **定期执行**: 建议每天执行一次完整测试
2. **保存报告**: 重要的报告应备份保存
3. **监控趋势**: 关注性能测试结果的变化趋势
4. **及时处理**: 发现失败项应立即排查处理

## 未来扩展

可以考虑添加的功能：

- [ ] 故障转移测试
- [ ] 负载测试
- [ ] 备份恢复测试
- [ ] 并发连接测试
- [ ] 慢查询分析
- [ ] 邮件/钉钉告警集成
